name: Manual PR Review

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'Full PR URL (e.g., https://github.com/owner/repo/pull/123)'
        required: true
        type: string
      review_focus:
        description: 'Review focus'
        required: false
        type: choice
        default: 'general'
        options:
          - general
          - security
          - performance
          - code-quality
          - tests

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Parse PR URL
        id: parse
        run: |
          PR_URL="${{ inputs.pr_url }}"

          if [[ $PR_URL =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
            OWNER="${BASH_REMATCH[1]}"
            REPO="${BASH_REMATCH[2]}"
            PR_NUMBER="${BASH_REMATCH[3]}"

            echo "owner=$OWNER" >> $GITHUB_OUTPUT
            echo "repo=$REPO" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "repo_full=$OWNER/$REPO" >> $GITHUB_OUTPUT

            echo "âœ… Parsed: $OWNER/$REPO PR #$PR_NUMBER"
          else
            echo "âŒ Invalid PR URL format"
            exit 1
          fi

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse.outputs.repo_full }}
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Prepare PR context
        id: pr_info
        run: |
          REPO_FULL="${{ steps.parse.outputs.repo_full }}"
          PR_NUMBER="${{ steps.parse.outputs.pr_number }}"

          PR_DATA=$(gh pr view $PR_NUMBER -R $REPO_FULL --json headRefName,baseRefName,title,body,author)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          BASE_REF=$(echo "$PR_DATA" | jq -r '.baseRefName')
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')

          echo "Fetching branches..."
          git fetch origin $HEAD_REF
          git fetch origin $BASE_REF

          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT

          # Create review prompt file
          cat > review_prompt.md << 'PROMPT_EOF'
          You are a senior code reviewer. Review this pull request thoroughly.

          PROMPT_EOF

          cat >> review_prompt.md << PROMPT_EOF
          ## PR Information
          - Repository: $REPO_FULL
          - PR Number: #$PR_NUMBER
          - Title: $PR_TITLE
          - Author: @$PR_AUTHOR
          - Base Branch: $BASE_REF
          - Head Branch: $HEAD_REF
          - Review Focus: ${{ inputs.review_focus }}

          ## Changed Files
          PROMPT_EOF

          git diff --name-status origin/$BASE_REF...origin/$HEAD_REF >> review_prompt.md
          echo "" >> review_prompt.md
          echo "## Statistics" >> review_prompt.md
          git diff --stat origin/$BASE_REF...origin/$HEAD_REF >> review_prompt.md
          echo "" >> review_prompt.md
          echo "## Full Diff" >> review_prompt.md
          echo '```diff' >> review_prompt.md
          git diff -U5 origin/$BASE_REF...origin/$HEAD_REF >> review_prompt.md
          echo '```' >> review_prompt.md

          cat >> review_prompt.md << 'PROMPT_EOF'

          ## Review Instructions

          Analyze the changes and provide:
          1. **Summary**: Brief overview of what this PR does
          2. **Issues by Severity**:
             - ðŸ”´ Critical: Security vulnerabilities, data loss risks, breaking changes
             - ðŸŸ  Major: Bugs, performance issues, missing error handling
             - ðŸŸ¡ Minor: Code style, naming, minor improvements
          3. **Positive Highlights**: Good practices observed
          4. **Recommendation**: APPROVE, REQUEST_CHANGES, or COMMENT

          Format your response in markdown suitable for a GitHub PR comment.
          PROMPT_EOF

          echo "Review prompt created:"
          wc -l review_prompt.md
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Install opencode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Run review with opencode
        id: review
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          # Run opencode with JSON format to extract final response
          opencode run "$(cat review_prompt.md)" --model deepseek/deepseek-chat --format json 2>&1 | tee review_raw.json || true

          # Extract text responses and find the one containing the review (has "Summary" section)
          grep '"type":"text"' review_raw.json | while read -r line; do
            text=$(echo "$line" | jq -r '.part.text // empty')
            if echo "$text" | grep -q "## Summary"; then
              echo "$text" > review_output.md
              break
            fi
          done

          # Fallback: get the last text response if no Summary found
          if [ ! -s review_output.md ]; then
            grep '"type":"text"' review_raw.json | tail -1 | \
              jq -r '.part.text // empty' > review_output.md 2>/dev/null || true
          fi

          # Clean up: ensure file has content
          if [ ! -s review_output.md ]; then
            echo "Review generation failed - no output captured" > review_output.md
          fi

          echo "Review completed"
          echo "--- Review Output Preview ---"
          head -50 review_output.md
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

      - name: Post review comment
        run: |
          REPO_FULL="${{ steps.parse.outputs.repo_full }}"
          PR_NUMBER="${{ steps.parse.outputs.pr_number }}"

          # Read review output and post as PR comment
          gh pr comment $PR_NUMBER -R $REPO_FULL --body-file review_output.md

          echo "âœ… Review posted to ${{ inputs.pr_url }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
